-- Simple and slow implementation of sigma clipping; this query is not
-- incremental, so it can re-scans points on every iteration.

Good = SCAN(public:adhoc:Points, v:float);

-- number of allowed standard deviations
N = [2];

DO
    mean = [FROM Good EMIT val=AVG(v)];
    std = [FROM Good EMIT val=STDEV(v)];
    NewBad = [FROM Good WHERE ABS(Good.v - *mean) > *N * *std EMIT *];
    Good = DIFF(Good, NewBad);
    continue = [FROM NewBad EMIT COUNT(NewBad.v) > 0];
WHILE continue;

DUMP(Good);
